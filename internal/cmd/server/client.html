<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script>
    window.addEventListener("load", function (evt) {

      var output = document.getElementById("output");
      var nick = document.getElementById("nick");
      var msg = document.getElementById("msg");
      var ws;

      var print = function (message) {
        var d = document.createElement("div");
        d.textContent = message;
        output.appendChild(d);
        output.scroll(0, output.scrollHeight);
      };

      document.getElementById("open").onclick = function (evt) {
        if (ws) {
          return false;
        }
        ws = new WebSocket("{{.}}");
        ws.onopen = function (evt) {
          // print("OPEN");
        }
        ws.onclose = function (evt) {
          // print("CLOSE");
          ws = null;
        }
        ws.onmessage = function (evt) {
          var response = JSON.parse(evt.data)
          print(`${response.user}: ${response.message}`);
        }
        ws.onerror = function (evt) {
          print("ERROR: " + evt.data);
        }
        return false;
      };

      document.getElementById("clear").onclick = function (evt) {
        fetch("http://localhost:8081/truncate")
        return false
      };

      document.getElementById("send").onclick = function (evt) {
        if (!ws) {
          return false;
        }

        var j = JSON.stringify({
          user: nick.value,
          message: msg.value
        })

        ws.send(j);
        return false;
      };

      document.getElementById("close").onclick = function (evt) {
        if (!ws) {
          return false;
        }
        ws.close();
        return false;
      };

    });
  </script>
</head>

<body>
  <table>
    <tr>
      <td valign="top" width="50%">
        <p>Click "Open" to create a connection to the server,
          "Send" to send a message to the server and "Close" to close the connection.
          You can change the message and send multiple times.
        <p>
        <form>
          <button id="open">Open</button>
          <button id="close">Close</button>
          <button id="clear">Clear</button>
          <p><input id="nick" type="text" value="">
            <input id="msg" type="text" value="">
            <button id="send">Send</button>
        </form>
      </td>
      <td valign="top" width="50%">
        <div id="output" style="max-height: 70vh;overflow-y: scroll;"></div>
      </td>
    </tr>
  </table>
</body>

</html>
